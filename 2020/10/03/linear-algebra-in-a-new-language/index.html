<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#F15A29">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="alternate" type="application/rss+xml" title="not://files v3.0" href="https://notfiles.xyz/feed.xml">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Linear algebra in a new language | not://files v3.0</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Linear algebra in a new language" />
<meta name="author" content="Calle Englund" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="For reasons unknown, I stumbled onto the [Zig] programming language, a new, still in development, low-level systems programming language; like C, but without all the bad things. So I guess quite different from C, but syntax is similarish. It uses LLVM as compiler backend, so it pretty much runs on everything less than 20 years old, and crosscompiles like that’s what you always do." />
<meta property="og:description" content="For reasons unknown, I stumbled onto the [Zig] programming language, a new, still in development, low-level systems programming language; like C, but without all the bad things. So I guess quite different from C, but syntax is similarish. It uses LLVM as compiler backend, so it pretty much runs on everything less than 20 years old, and crosscompiles like that’s what you always do." />
<link rel="canonical" href="https://notfiles.xyz/2020/10/03/linear-algebra-in-a-new-language/" />
<meta property="og:url" content="https://notfiles.xyz/2020/10/03/linear-algebra-in-a-new-language/" />
<meta property="og:site_name" content="not://files v3.0" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-03T17:15:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Linear algebra in a new language" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Calle Englund"},"dateModified":"2020-10-03T17:15:00+02:00","datePublished":"2020-10-03T17:15:00+02:00","description":"For reasons unknown, I stumbled onto the [Zig] programming language, a new, still in development, low-level systems programming language; like C, but without all the bad things. So I guess quite different from C, but syntax is similarish. It uses LLVM as compiler backend, so it pretty much runs on everything less than 20 years old, and crosscompiles like that’s what you always do.","headline":"Linear algebra in a new language","mainEntityOfPage":{"@type":"WebPage","@id":"https://notfiles.xyz/2020/10/03/linear-algebra-in-a-new-language/"},"url":"https://notfiles.xyz/2020/10/03/linear-algebra-in-a-new-language/"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css" integrity="sha384-ZPe7yZ91iWxYumsBEOn7ieg8q/o+qh/hQpSaPow8T6BwALcXSCS6C6fSRPIAnTQs" crossorigin="anonymous">

  <!-- The loading of KaTeX is deferred to speed up page rendering -->
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js" integrity="sha384-ljao5I1l+8KYFXG7LNEA7DyaFvuvSCmedUf6Y6JI7LJqiu8q5dEivP2nDdFH31V4" crossorigin="anonymous"></script>

  <!-- To automatically render math in text elements, include the auto-render extension: -->
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
      onload="renderMathInElement(document.body);"></script>
</head>
<body><header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="/">not://files v3.0</a><nav class="site-nav" id="site-navigation" aria-label="Menu">
  <label for="site-menu-toggle" class="menu-icon" aria-label="Menu">
    <i class="fas fa-bars"></i>
  </label>
  <input id="site-menu-toggle" class="menu-toggle" type="checkbox"/><ul id="site-menu" class="menu">
    <li class="menu-item">
      <a class="page-link" href="/posts/">
          All Posts
        </a></li>
    <li class="menu-item">
      <a class="page-link" href="/archive/">
          Archives
        </a></li>
    <li class="menu-item">
      <a class="page-link" href="/category/">
          Categories
        </a></li>
    <li class="menu-item">
      <a class="page-link" href="/tag/">
          Tags
        </a></li>
</ul>
</nav>
</div>
</header>
<section class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Linear algebra in a new language</h1>
    <div class="post-meta"><time datetime="2020-10-03T17:15:00+02:00" itemprop="datePublished">Saturday, 2020-10-03</time>
       in
    <a href="/category/devlog/"
       title="Development Logs">devlog</a>
   about
    <a href="/tag/algebra/" title="applications of linear algebra">
      #algebra</a>,
  
    <a href="/tag/zig/" title="coding in Zig">
      #zig</a>
  </div></header>

  <section class="post-content" itemprop="articleBody">
    <p>For reasons unknown, I stumbled onto the <a href="https://ziglang.org">Zig</a> programming language, a new, still in development, low-level systems programming language; like C, but without all the bad things. So I guess quite different from C, but syntax is similarish. It uses LLVM as compiler backend, so it pretty much runs on everything less than 20 years old, and crosscompiles like that’s what you always do.</p>

<p>I decided to write a nice generic API for the subset of Linear Algebra that’s needed for 3D computer graphics, in case I want to write another raytracer in the near future, and optimize for performance this time.</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">test</span> <span class="s">"vector cross product"</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">x</span> <span class="o">=</span> <span class="n">vector</span><span class="p">([</span><span class="mi">_</span><span class="p">]</span><span class="kt">f32</span><span class="p">{</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">});</span>
    <span class="k">const</span> <span class="n">y</span> <span class="o">=</span> <span class="n">vector</span><span class="p">([</span><span class="mi">_</span><span class="p">]</span><span class="kt">f32</span><span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">});</span>
    <span class="k">const</span> <span class="n">z</span> <span class="o">=</span> <span class="n">vector</span><span class="p">([</span><span class="mi">_</span><span class="p">]</span><span class="kt">f32</span><span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="p">});</span>

    <span class="n">expectEqual</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">.</span><span class="nf">cross</span><span class="p">(</span><span class="n">z</span><span class="p">));</span>
    <span class="n">expectEqual</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="nf">cross</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
    <span class="n">expectEqual</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="nf">cross</span><span class="p">(</span><span class="n">y</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>One very cool feature that makes this possible in a statically typed, <a href="https://en.wikipedia.org/wiki/Ahead-of-time_compilation">AOT</a> compiled language is that the compiler actually interprets as much of the code it can at compile time, making the language meta-programmable in itself.</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// return anytype inference is currently a TODO compiler error so</span>
<span class="c">// the switch on type must be duplicated instead</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="n">vector</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">anytype</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">switch</span> <span class="p">(</span><span class="nb">@typeInfo</span><span class="p">(</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span> <span class="p">{</span>
        <span class="p">.</span><span class="py">Array</span> <span class="o">=&gt;</span> <span class="p">|</span><span class="n">t</span><span class="p">|</span> <span class="n">VecT</span><span class="p">([</span><span class="n">t</span><span class="p">.</span><span class="py">len</span><span class="p">]</span><span class="n">t</span><span class="p">.</span><span class="py">child</span><span class="p">),</span>
        <span class="p">.</span><span class="py">Vector</span> <span class="o">=&gt;</span> <span class="p">|</span><span class="n">t</span><span class="p">|</span> <span class="n">VecT</span><span class="p">([</span><span class="n">t</span><span class="p">.</span><span class="py">len</span><span class="p">]</span><span class="n">t</span><span class="p">.</span><span class="py">child</span><span class="p">),</span>
        <span class="k">else</span> <span class="o">=&gt;</span> <span class="nb">@compileError</span><span class="p">(</span><span class="s">"cannot cast from "</span> <span class="o">++</span> <span class="nb">@typeName</span><span class="p">(</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">arg</span><span class="p">))),</span>
    <span class="p">}).</span><span class="nf">cast</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This constructor takes any array slice of a numeric type, or a SIMD vector, and casts into a matching <code class="language-plaintext highlighter-rouge">struct{x:f32, ...}</code> value, for convenient element access. Because types are first-class values at comptime, this is done at comptime, and reduces to <code class="language-plaintext highlighter-rouge">VecT(...).cast(...)</code>, and futher on because the actual value of <code class="language-plaintext highlighter-rouge">arg</code> does not need to be known, only its type, so those functions are also evaluated at comptime, creating the proper type <code class="language-plaintext highlighter-rouge">struct{x:f32, ...}</code> with specialized versions of all generic functions. Then the specialized <code class="language-plaintext highlighter-rouge">cast()</code> function, still at comptime, does type coersion and safely reinterprets the value as itself. Any errors found are raised as compile errors, with a proper call trace of how it got there, instead of just the file name and line number.</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">Simd</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">meta</span><span class="p">.</span><span class="nf">Vector</span><span class="p">(</span><span class="nb">@This</span><span class="p">().</span><span class="py">len</span><span class="p">,</span> <span class="nb">@This</span><span class="p">().</span><span class="py">T</span><span class="p">);</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="n">cross</span><span class="p">(</span><span class="n">u</span><span class="p">:</span> <span class="nb">@This</span><span class="p">(),</span> <span class="n">v</span><span class="p">:</span> <span class="nb">@This</span><span class="p">())</span> <span class="nb">@This</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">use_simd</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">u_yzx</span><span class="p">:</span> <span class="n">Simd</span> <span class="o">=</span> <span class="o">.</span><span class="p">{</span> <span class="n">u</span><span class="p">.</span><span class="py">y</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="py">z</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="py">x</span> <span class="p">};</span>
        <span class="k">const</span> <span class="n">u_zxy</span><span class="p">:</span> <span class="n">Simd</span> <span class="o">=</span> <span class="o">.</span><span class="p">{</span> <span class="n">u</span><span class="p">.</span><span class="py">z</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="py">x</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="py">y</span> <span class="p">};</span>
        <span class="k">const</span> <span class="n">v_yzx</span><span class="p">:</span> <span class="n">Simd</span> <span class="o">=</span> <span class="o">.</span><span class="p">{</span> <span class="n">v</span><span class="p">.</span><span class="py">y</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="py">z</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="py">x</span> <span class="p">};</span>
        <span class="k">const</span> <span class="n">v_zxy</span><span class="p">:</span> <span class="n">Simd</span> <span class="o">=</span> <span class="o">.</span><span class="p">{</span> <span class="n">v</span><span class="p">.</span><span class="py">z</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="py">x</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="py">y</span> <span class="p">};</span>

        <span class="k">return</span> <span class="nb">@This</span><span class="p">().</span><span class="nf">cast</span><span class="p">(</span><span class="n">u_yzx</span> <span class="o">*</span> <span class="n">v_zxy</span> <span class="o">-</span> <span class="n">u_zxy</span> <span class="o">*</span> <span class="n">v_yzx</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">@This</span><span class="p">(){</span>
            <span class="p">.</span><span class="py">x</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="py">y</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="py">z</span> <span class="o">-</span> <span class="n">u</span><span class="p">.</span><span class="py">z</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="py">y</span><span class="p">,</span>
            <span class="p">.</span><span class="py">y</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="py">z</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="py">x</span> <span class="o">-</span> <span class="n">u</span><span class="p">.</span><span class="py">x</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="py">z</span><span class="p">,</span>
            <span class="p">.</span><span class="py">z</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="py">x</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="py">y</span> <span class="o">-</span> <span class="n">u</span><span class="p">.</span><span class="py">y</span> <span class="o">*</span> <span class="n">v</span><span class="p">.</span><span class="py">x</span><span class="p">,</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">cross()</code> function is comptime specialized for the <code class="language-plaintext highlighter-rouge">@This()</code> type, and allows conditional compilation of the SIMD or non-SIMD implementation. And again the <code class="language-plaintext highlighter-rouge">Simd</code> data type is also specialized at comptime with help of the meta programming submodule of the standard library. Due to lazy evaluation at comptime, this only happens if the SIMD version is compiled, with no need for extra guards to avoid dead code.</p>

<p>If we want to run benchmarks to see of the attempted SIMD optimization gave any performance boost, we can simple instanciate all the versions of the vector type and compare.</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Benchmark</span>                          <span class="n">Mean</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
<span class="o">-------------------------------------------</span>
<span class="n">cross_cold</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f16</span><span class="p">,</span> <span class="n">SIMD</span><span class="p">)</span>              <span class="mf">6.149</span>
<span class="n">cross_cold</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f32</span><span class="p">,</span> <span class="n">SIMD</span><span class="p">)</span>              <span class="mf">1.619</span>
<span class="n">cross_cold</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f64</span><span class="p">,</span> <span class="n">SIMD</span><span class="p">)</span>              <span class="mf">1.708</span>
<span class="n">cross_cold</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f16</span><span class="p">,</span> <span class="n">non</span><span class="o">-</span><span class="n">SIMD</span><span class="p">)</span>          <span class="mf">4.245</span>
<span class="n">cross_cold</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f32</span><span class="p">,</span> <span class="n">non</span><span class="o">-</span><span class="n">SIMD</span><span class="p">)</span>          <span class="mf">1.247</span>
<span class="n">cross_cold</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f64</span><span class="p">,</span> <span class="n">non</span><span class="o">-</span><span class="n">SIMD</span><span class="p">)</span>          <span class="mf">1.080</span>
<span class="n">cross_hot</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f16</span><span class="p">,</span> <span class="n">SIMD</span><span class="p">)</span>               <span class="mf">0.842</span>
<span class="n">cross_hot</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f32</span><span class="p">,</span> <span class="n">SIMD</span><span class="p">)</span>               <span class="mf">0.840</span>
<span class="n">cross_hot</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f64</span><span class="p">,</span> <span class="n">SIMD</span><span class="p">)</span>               <span class="mf">0.832</span>
<span class="n">cross_hot</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f16</span><span class="p">,</span> <span class="n">non</span><span class="o">-</span><span class="n">SIMD</span><span class="p">)</span>           <span class="mf">0.847</span>
<span class="n">cross_hot</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f32</span><span class="p">,</span> <span class="n">non</span><span class="o">-</span><span class="n">SIMD</span><span class="p">)</span>           <span class="mf">0.841</span>
<span class="n">cross_hot</span><span class="p">([</span><span class="mi">3</span><span class="p">]</span><span class="kt">f64</span><span class="p">,</span> <span class="n">non</span><span class="o">-</span><span class="n">SIMD</span><span class="p">)</span>           <span class="mf">0.897</span>
</code></pre></div></div>

<p>It seems like that when data is hot in the cache, it doesn’t really matter, but cold data has much worse performance for the SIMD implementation, so that SIMD shuffle load code needs some work, and even then this particular operation doesn’t gain anything, at least not on this i7 CPU.</p>

<p>Running the same language dynamically interpreted at compile time, as statically at runtime really is the best of both worlds; the blazing runtime speed of a static language, and most of the in-language meta programming capabilities of a dynamic language.</p>


  </section>
</article>
<section class="post-list"><h2>Previous related</h2><article class="post-item">
  <header class="post-header">
    <h3 class="post-link">
      <a href="/2018/11/30/day-0-tuple-basics/" >
        Day 0, Tuple Basics
      </a>
    </h3>
    <div class="post-meta">Friday, 2018-11-30 in
    <a href="/category/devlog/"
       title="Development Logs">devlog</a>
   about
    <a href="/tag/devember/" title="participation in Devember">
      #devember</a>,
  
    <a href="/tag/devember2018/" title="Devember 2018 ray tracer challenge">
      #devember2018</a>,
  
    <a href="/tag/ruby/" title="coding in Ruby">
      #ruby</a>,
  
    <a href="/tag/algebra/" title="applications of linear algebra">
      #algebra</a>,
  
    <a href="/tag/hourofcode/" title="coding for one hour per day">
      #hourofcode</a>,
  
    <a href="/tag/raytracerchallenge/" title="">
      #raytracerchallenge</a>
  
    </div>
  </header>
  <section class="post-excerpt">
    <blockquote>
      Oops, I started a day early.

    </blockquote>
  </section>
</article>
</section>

      </div>
    </section><footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Calle Englund</li>
          <li><a href="mailto:calle@notfiles.xyz">calle@notfiles.xyz</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list"><li title="GitHub">
            <a rel="me" href="https://github.com/notCalle">
              <i class="icon fab fa-github"></i>
              notCalle
            </a>
          </li><li title="Mastodon">
            <a rel="me" href="https://mstdn.social/@notCalle">
              <i class="icon fab fa-mastodon"></i>
              @notCalle@mstdn.social
            </a>
          </li><li title="Twitter">
            <a rel="me" href="https://twitter.com/@notCalle">
              <i class="icon fab fa-twitter"></i>
              @notCalle
            </a>
          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        Random development ramblings, maybe.

      </div>
    </div>

  </div>

</footer>
</body>
</html>
